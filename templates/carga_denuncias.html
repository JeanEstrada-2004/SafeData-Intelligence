{% extends "base.html" %}

{% block title %}Carga de Denuncias - Sistema de Denuncias{% endblock %}

{% block header %}Carga de Denuncias{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <!-- Instrucciones -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-info-circle me-2"></i>
          Instrucciones de Carga
        </h6>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <h6 class="alert-heading">Formato del archivo (Excel/CSV) requerido:</h6>
          <p class="mb-2">Tu archivo debe incluir estas columnas (encabezados exactos):</p>
          <ul class="mb-0">
            <li><strong>numero_parte</strong></li>
            <li><strong>estado_denuncia</strong></li>
            <li><strong>zona_denuncia</strong> (entero 1..7)</li>
            <li><strong>origen_denuncia</strong></li>
            <li><strong>naturaleza_personal</strong></li>
            <li><strong>forma_patrullaje</strong></li>
            <li><strong>turno</strong></li>
            <li><strong>fecha_hora_suceso</strong> (ej: 15/10/2025 09:15)</li>
            <li><strong>fecha_hora_alerta</strong> (opcional)</li>
            <li><strong>fecha_hora_llegada</strong> (opcional)</li>
            <li><strong>edad_victima</strong> (opcional)</li>
            <li><strong>sexo_victima</strong></li>
            <li><strong>distrito_victima</strong></li>
            <li><strong>sexo_victimario</strong> (opcional)</li>
            <li><strong>relacion_victima_victimario</strong> (opcional)</li>
            <li><strong>tipo_denuncia</strong> (opcional)</li>
            <li><strong>arma_instrumento</strong> (opcional)</li>
            <li><strong>resultado_ocurrencia</strong> (opcional)</li>
            <li><strong>lugar_ocurrencia</strong> (opcional)</li>
            <li><strong>direccion_ocurrencia</strong> (opcional)</li>
            <li><strong>comentarios</strong> (opcional)</li>
          </ul>
          <small class="text-muted d-block mt-2">
            * Se admiten formatos de fecha/hora comunes (por ejemplo <em>DD/MM/YYYY HH:MM</em>) y CSV con separador <em>,</em> o <em>;</em>.
          </small>
        </div>
      </div>
    </div>

    <!-- Formulario de carga -->
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-upload me-2"></i>
          Subir Archivo
        </h6>
      </div>
      <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="mb-4">
            <label for="excelFile" class="form-label">Seleccionar archivo (.xlsx, .xls, .csv)</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls,.csv" required>
            <div class="form-text">Se aceptan Excel (.xlsx/.xls) o CSV (.csv)</div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="button" class="btn btn-secondary me-md-2" onclick="resetForm()">
              <i class="fas fa-undo me-2"></i>Limpiar
            </button>
            <button type="submit" class="btn btn-primary" id="uploadBtn">
              <i class="fas fa-upload me-2"></i>Cargar Denuncias
            </button>
          </div>
        </form>

        <!-- Progress bar -->
        <div id="progressContainer" class="mt-3" style="display: none;">
          <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
          </div>
        </div>

        <!-- Resultados (errores) -->
        <div id="resultContainer" class="mt-3" style="display: none;">
          <div id="resultAlert"></div>
        </div>
      </div>
    </div>

    <!-- Ejemplo de archivo -->
    <div class="card shadow mt-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-success">
          <i class="fas fa-download me-2"></i>
          Archivo de Ejemplo
        </h6>
      </div>
      <div class="card-body text-center">
        <p class="text-muted">Descarga un archivo de ejemplo con el formato actualizado:</p>
        <button class="btn btn-success" onclick="downloadExample()">
          <i class="fas fa-file-excel me-2"></i>
          Descargar Ejemplo Excel
        </button>

      </div>
    </div> <br> <br>
  </div>
</div>

<!-- Modal de confirmación -->
<div class="modal fade" id="uploadSuccessModal" tabindex="-1" aria-hidden="true" aria-labelledby="uploadSuccessLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="uploadSuccessLabel">
          <i class="fas fa-check-circle me-2"></i> Carga exitosa
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p id="successMsg" class="mb-2">Se cargaron las denuncias correctamente.</p>
        <div class="text-center text-muted small">
          <i class="fas fa-clock me-1"></i>
          Redirigiendo al listado en <span id="countdown">3</span> segundos...
        </div>
      </div>
      <div class="modal-footer">
        <a href="/listado-denuncias" class="btn btn-primary" id="goNowBtn">
          <i class="fas fa-list me-2"></i> Ver listado ahora
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const fileInput = document.getElementById('excelFile');
  const uploadBtn = document.getElementById('uploadBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');

  if (!fileInput.files[0]) {
    showAlert('Por favor selecciona un archivo', 'danger');
    return;
  }

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);

  // Mostrar progreso
  uploadBtn.disabled = true;
  uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
  progressContainer.style.display = 'block';
  progressBar.style.width = '50%';

  try {
    const response = await fetch('/api/denuncias/upload-excel/', { method: 'POST', body: formData });
    progressBar.style.width = '100%';

    const result = await response.json();

    if (response.ok) {
      // ✅ Modal de éxito
      showSuccessModal(result.message || 'Archivo procesado con éxito');
    } else {
      showAlert(result.detail || 'Error al procesar el archivo', 'danger');
    }
  } catch (error) {
    showAlert('Error de conexión: ' + error.message, 'danger');
  } finally {
    // Restablece barra (el modal gestiona la redirección en éxito)
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Cargar Denuncias';
  }
});

function showAlert(message, type) {
  const resultContainer = document.getElementById('resultContainer');
  const resultAlert = document.getElementById('resultAlert');

  resultAlert.innerHTML = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
  resultContainer.style.display = 'block';
}

function resetForm() {
  document.getElementById('uploadForm').reset();
  document.getElementById('resultContainer').style.display = 'none';
  document.getElementById('progressContainer').style.display = 'none';
}

function downloadExample() {
  // Sirve el archivo desde /static (colócalo en esa ruta en el servidor)
  window.location.href = '/static/uploads/demo_informe_denuncias.xlsx';
}

/* ===== Modal de éxito con redirección ===== */
function showSuccessModal(message) {
  const msgEl = document.getElementById('successMsg');
  const countEl = document.getElementById('countdown');
  msgEl.textContent = message || 'Se cargaron las denuncias correctamente.';
  countEl.textContent = '3';

  // Evita cerrar por ESC o click fuera (que el usuario vea la confirmación)
  const modalEl = document.getElementById('uploadSuccessModal');
  const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
  modal.show();

  // Cuenta regresiva
  let seconds = 5;
  const interval = setInterval(() => {
    seconds--;
    countEl.textContent = seconds;
    if (seconds <= 0) clearInterval(interval);
  }, 1000);

  // Redirección automática
  const redirectTimer = setTimeout(() => {
    window.location.href = '/listado-denuncias';
  }, 3000);

  // Si el usuario cierra el modal, mantenemos la redirección (o podrías cancelarla con clearTimeout)
  modalEl.addEventListener('hidden.bs.modal', () => {
    // clearTimeout(redirectTimer); // descomenta si NO quieres redirigir al cerrar manualmente
  }, { once: true });
}
</script>
{% endblock %}
